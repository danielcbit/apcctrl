#!/bin/bash


apcupsd_error()
{
	echo -en "\e[31m\e[5m"
	echo -en "\nERROR!!! "
	echo -n "$1"
	echo -en "!!!\n\n"
	echo -en "\e[49m\e[39m\e[0m"

	export PATH="${PATH_OLD}"
	echo -e "RESTORE PATH=${PATH}"
	echo -e "********************* FIM ********************"

	exit 2
}

apcupsd_mingw()
{
	echo "mingw..."
	mingw32-g++ -v &>.out.mingw
	if [[ $? == "0" ]]; then
		return 0;
	fi;

	cat .out.mingw
	return 1;
}
apcupsd_path()
{
	if [[ -e "${APTUPSD_PATH}" ]]; then
		apcupsd_error "O Caminho ${APCUPSD_PATH} jÃ¡ existe"
	fi;
	return 0;
}
apcupsd_svn()
{
	echo "svn..."
	svn checkout http://svn.code.sf.net/p/apcupsd-brazil/svn/tags/${TAG} ${APCUPSD_PATH} &>.out.svn
	if [[ $? == "0" ]]; then
		return 0;
	fi;

	cat .out.svn
	return 1;
}

apcupsd_configure()
{
	echo "configure..."
	cd ${APCUPSD_PATH}
	CONFIG=$(./configure --host=mingw32 \
	       --prefix=/apcupsd \
	       --sbindir=/apcupsd/bin \
	       --sysconfdir=/apcupsd/etc/apcupsd \
	       --with-pid-dir=/apcupsd/etc/apcupsd \
	       --mandir=/apcupsd \
	       --enable-net \
	       --disable-apcsmart \
	       --disable-dumb \
	       --disable-snmp \
	       --disable-usb \
	       --disable-net-snmp \
	       --disable-test \
	       --disable-pcnet \
	       --disable-modbus-usb \
	       --disable-modbus \
	       --enable-cgi &>.out.configure
	)
	if [[ $? == "0" ]]; then
		return 0;
	fi;

	cat .out.configure
	return 1;
}

apcupsd_make()
{
	echo "make..."
	cd ${APCUPSD_PATH}
	make &>.out.make
	if [[ $? == "0" ]]; then
		return 0;
	fi;

	cat .out.make
	return 1;

}

apcupsd_installer() 
{
	echo "installer..."
	cd ${APCUPSD_PATH}/platforms/mingw/
	make winapcupsd.exe &>.out.installer
	if [[ $? == "0" ]]; then
		return 0;
	fi;

	cat .out.installer
	return 1;
}
apcupsd_scp()
{
#platforms/mingw/installer/winapcctrl-0.6.0.exe
	echo "scp..."
	scp ${APCUPSD_PATH}/platforms/mingw/installer/winapcctrl-${TAG}.exe ${REMOTE_USER}@${REMOTE_SERVER}:${REMOTE_PATH} &>.out.scp
	if [[ $? == "0" ]]; then
		return 0;
	fi;

	cat .out.scp
	return 1;
}

if [[ -z "$1" ]]; then
	apcupsd_error "Utilize o formato:
compile TAG_NUMBER
TAG_NUMBER = x.x.x"
fi;

TAG=$(echo "${1}" | sed -n '/[0-9]\+\.[0-9]\+\.[0-9]\+/p')

if [[ -z "${TAG}" ]]; then
	apcupsd_error "Utilize o formato:
compile TAG_NUMBER
TAG_NUMBER = x.x.x"
fi;

REMOTE_USER="wagner"
REMOTE_SERVER="192.168.22.4"
REMOTE_PATH=/home/wagner/workspace/apcupsd_brazil_tars

APCUPSD_PATH="/home/wagner/apcupsd-brazil/apcupsd-brazil-${TAG}"

PATH_OLD="${PATH}"
export PATH="/home/wagner/apcupsd-brazil/cross-tools/mingw32/bin:${PATH}"

echo -en "APCUPSD_PATH=${APCUPSD_PATH}\n"
echo -en "PATH=${PATH}\n\n"

apcupsd_path
if [[ $? != "0" ]]; then
	apcupsd_error path
fi;
apcupsd_mingw
if [[ $? != "0" ]]; then
	apcupsd_error mingw
fi;
apcupsd_svn
if [[ $? != "0" ]]; then
	apcupsd_error svn
fi;
apcupsd_configure
if [[ $? != "0" ]]; then
	apcupsd_error configure
fi;
apcupsd_make
if [[ $? != "0" ]]; then
	apcupsd_error make
fi;
apcupsd_installer
if [[ $? != "0" ]]; then
	apcupsd_error installer
fi;
apcupsd_scp
if [[ $? != "0" ]]; then
	apcupsd_error scp
fi;

echo -en "\e[40m\e[32m\e[5m"
echo -en "\nSUCESS!!! File: /tmp/winapcupsd-brazil-${TAG}.exe\n\n";
echo -en "\e[49m\e[39m\e[0m"

export PATH="${PATH_OLD}"
echo -e "RESTORE PATH=${PATH}"
echo -e "********************* FIM ********************"
